<!doctype html>
<html>
	<head>
		<title>Simple Snake Game</title>
		<meta charset="utf-8">
		<link rel="icon" href="icon.png">
		<script>
			var ctx;
			var fps = 12, last, residue;
			var isdankmode = false;
			var c = { // control
				tom: [1, 0], // tomove
				pos: [[0, 0]],
				gro: 0, // growth queue
				gra: 2, // growth amount
				hch: false, // has changed dir
				fpo: [null, null] // food pos
			};
			var w = { // world
				dim: 28, // x*x dimension
				csz: 20, // cell size
				sco: 0, // score
				pau: false // paused
			}
			window.onload = function() {
				var canv = document.createElement("canvas");
				document.body.appendChild(canv);
				ctx = canv.getContext("2d");
				canv.width = w.csz * w.dim;
				canv.height = w.csz * w.dim;
				window.onkeydown = function(e) {
					if (w.pau && e.key != " ")
						unpause();
					if (!w.pau && e.key == " ")
						pause();
					switch (e.key) {
						case "ArrowUp":
						case "w":
							if ((c.tom[1] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [0, -1];
								haschanged = true;
							}
							break;
						case "ArrowLeft":
						case "a":
							if ((c.tom[0] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [-1, 0];
								haschanged = true;
							}
							break;
						case "ArrowDown":
						case "s":
							if ((c.tom[1] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [0, 1];
								haschanged = true;
							}
							break;
						case "ArrowRight":
						case "d":
							if ((c.tom[0] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [1, 0];
								haschanged = true;
							}
							break;
					}
				}
				window.onblur = function() {
					pause();
				}
				var content = document.createElement("div");
				content.setAttribute("id", "content");
				content.style.position = "absolute";
				content.style.left = "50%";
				content.style.marginLeft = "-" + ((1 + w.csz * w.dim) / 2) + "px";
				content.style.top = w.csz + "px";
				content.style.width = w.csz * w.dim + "px";
				content.style.height = w.csz * w.dim + "px";
				content.style.backgroundColor = "red";
				content.style.border = "1px solid #000";
				content.style.boxShadow = "0px 0px 16px #303030";
				document.body.appendChild(content);
				for (var i = 0; i < w.dim * w.dim; i++) {
					var d = document.createElement("div");
					d.setAttribute("id", i);
					d.style.backgroundColor = ((i % 3 == 0) ? ("#afa") : ((i % 3 == 1) ? ("#9e9") : ("#8d8")));
					d.style.position = "absolute";
					d.style.left = (i % w.dim) * w.csz + "px";
					d.style.top = Math.floor(i / w.dim) * w.csz + "px";
					d.style.width = w.csz + "px";
					d.style.height = w.csz + "px";
					content.appendChild(d);
				}
				// debug("raw px margin-left content", window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz));
				
				var food = document.createElement("div");
				food.setAttribute("id", "food");
				food.style.position = "absolute";
				food.style.left = "50%";
				food.style.marginLeft = "-" + ((w.csz * w.dim) / 2) + "px";
				food.style.top = 1 + w.csz + "px";
				food.style.width = w.csz * w.dim + "px";
				food.style.height = w.csz * w.dim + "px";
				document.body.appendChild(food);
				
				// Initial food update (not pos[0, 0]) and render
				while (!(c.fpo[0] || c.fpo[1])) {
					c.fpo = [Math.floor(Math.random() * w.dim), Math.floor(Math.random() * w.dim)];
				}
				var fd = document.createElement("div");
				fd.style.position = "absolute";
				fd.style.left = (c.fpo[0] * w.csz) + "px";
				fd.style.top = (c.fpo[1] * w.csz) + "px";
				fd.style.width = w.csz + "px";
				fd.style.height = w.csz + "px";
				fd.style.background = "linear-gradient(135deg, #FFF 10%, #FE0 20%, #D40 70%)";
				fd.style.borderRadius = "50%";
				fd.style.boxShadow = "0px 0px 16px #303030";
				food.appendChild(fd);
				
				var snek = document.createElement("div");
				snek.setAttribute("id", "snek");
				snek.style.position = "absolute";
				snek.style.left = "50%";
				snek.style.marginLeft = "-" + ((w.csz * w.dim) / 2) + "px";
				snek.style.top = 1 + w.csz + "px";
				snek.style.width = w.csz * w.dim + "px";
				snek.style.height = w.csz * w.dim + "px";
				// snek.style.backgroundColor = "red";
				document.body.appendChild(snek);				
				
				// Initial snake render
				var sd = document.createElement("div");
				sd.style.position = "absolute";
				sd.style.left = (c.pos[c.pos.length - 1][0] * w.csz) + "px";
				sd.style.top = (c.pos[c.pos.length - 1][1] * w.csz) + "px";
				sd.style.width = w.csz + "px";
				sd.style.height = w.csz + "px";
				sd.style.backgroundColor = "#000";
				sd.style.boxShadow = "0px 0px 16px #303030";
				snek.appendChild(sd);
				
				var dmb = document.getElementById("darkmodebutton");
				dmb.style.top = (w.csz + 1) + "px";
				dmb.style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 103) + "px";
				var pb = document.getElementById("pausebutton");
				pb.style.top = (w.csz + 1) + 46 + "px";
				pb.style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 103) + "px";
				window.onresize = function() {
					dmb.style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 103) + "px";
					pb.style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 103) + "px";
				}	
				
				residue = 0;
				last = Date.now();
				window.requestAnimationFrame(main);
			}
			function main() {
				elap = Date.now() - last;
				if (elap + residue >= 1000 / fps) {
					residue = elap + residue - 1000 / fps;
					last = Date.now();
					// debug("timeError", Date.now() % 1000 + " " + residue);
					
					haschanged = false;
					// Update
					// Checks for predicted collision with food
					if (c.pos[c.pos.length - 1][0] + c.tom[0] == c.fpo[0] && c.pos[c.pos.length - 1][1] + c.tom[1] == c.fpo[1]) {
						w.sco += c.gra;
						c.gro += c.gra;
						// New food
						c.fpo = [Math.floor(Math.random() * w.dim), Math.floor(Math.random() * w.dim)];
						var fd = document.createElement("div");
						fd.style.position = "absolute";
						fd.style.left = (c.fpo[0] * w.csz) + "px";
						fd.style.top = (c.fpo[1] * w.csz) + "px";
						fd.style.width = w.csz + "px";
						fd.style.height = w.csz + "px";
						fd.style.background = "linear-gradient(135deg, #FFF 10%, #FE0 20%, #D40 70%)";
						fd.style.borderRadius = "50%";
						fd.style.boxShadow = "0px 0px 16px #303030";
						var food = document.getElementById("food");
						food.appendChild(fd);
						food.removeChild(food.querySelector("div"));
					}
					
					// Applies movement on whole segment
					c.pos.push([c.pos[c.pos.length - 1][0] + c.tom[0], c.pos[c.pos.length - 1][1] + c.tom[1]]);
					for (var i = 0; i < c.pos.length - 1; i++) {
						c.pos[i] = [c.pos[i + 1][0], [c.pos[i + 1][1]]];
					}
					
					// Growth handling below (requires update and render)
					
					// Render
					var sd = document.createElement("div");
					sd.style.position = "absolute";
					sd.style.left = (c.pos[c.pos.length - 1][0] * w.csz) + "px";
					sd.style.top = (c.pos[c.pos.length - 1][1] * w.csz) + "px";
					sd.style.width = w.csz + "px";
					sd.style.height = w.csz + "px";
					sd.style.backgroundColor = "#000";
					sd.style.boxShadow = "0px 0px 16px #303030";
					snek = document.getElementById("snek");
					snek.appendChild(sd);
					
					// Removes trailing segment if c.gro not in effect, otherwise decrementes c.gro
					if (c.gro >= 1) {
						c.gro--;
					} else {
						c.pos.shift();
						snek.removeChild(snek.querySelector("div"));
					}
				}
				if (!w.pau)
					window.requestAnimationFrame(main);
			}
			function debug(head, value) {
				console.log("debug " + head + ": " + value);
			}
			function toggledarkmode() {
				isdankmode = !isdankmode;
				if (isdankmode) {
					document.body.style.backgroundColor = "#000";
					document.getElementById("content").style.border = "1px solid #FFF";
					document.getElementById("darkmodebutton").value = "Light Mode";
				} else {
					document.body.style.backgroundColor = "#FFF";
					document.getElementById("content").style.border = "1px solid #000";
					document.getElementById("darkmodebutton").value = "Dark Mode";
				}
			}
			function pause() {
				if (!w.pau) {
					w.pau = true;
					var ps = document.createElement("div");
					ps.setAttribute("id", "pausescreen");
					ps.style.position = "absolute";
					ps.style.left = "0px";
					ps.style.top = "0px";
					ps.style.width = "100%";
					ps.style.height = "100%";
					ps.style.backgroundColor = "rgba(51, 51, 51, 0.75)";
					ps.onclick = function() {
						unpause();
					}
					document.body.appendChild(ps);
					var b1 = document.createElement("div");
					b1.style.position = "absolute";
					b1.style.left = window.innerWidth - (window.innerWidth / 2 + 58 + 16) + "px";
					b1.style.top = window.innerHeight / 2 - 77 + "px";
					b1.style.width = "58px";
					b1.style.height = "154px";
					b1.style.backgroundColor = "rgba(204, 204, 204, 0.75)";
					ps.appendChild(b1);
					var b2 = document.createElement("div");
					b2.style.position = "absolute";
					b2.style.left = window.innerWidth - (window.innerWidth / 2 - 16) + "px";
					b2.style.top = window.innerHeight / 2 - 77 + "px";
					b2.style.width = "58px";
					b2.style.height = "154px";
					b2.style.backgroundColor = "rgba(204, 204, 204, 0.75)";
					ps.appendChild(b2);
				}
			}
			function unpause() {
				document.body.removeChild(document.getElementById("pausescreen"));
				w.pau = false;
				last = Date.now() - 1000 / fps;
				residue = 0;
				window.requestAnimationFrame(main);
			}
		</script>
	</head>
	<body>
		<input type="button" id="darkmodebutton" value="Dark Mode" style="position: absolute; padding: 0; width: 74px; height: 30px; text-align: center; border: 1px solid black; opacity: 0.6; box-shadow: 0px 0px 16px #303030" onclick="toggledarkmode()">
		<input type="button" id="pausebutton" value="Pause" style="position: absolute; padding: 0; width: 74px; height: 30px; text-align: center; border: 1px solid black; opacity: 0.5; box-shadow: 0px 0px 16px #303030" onclick="pause()">
	</body>
</html>
