<!doctype html>
<html>
	<head>
		<title>Simple Snake Game</title>
		<meta charset="utf-8">
		<link rel="icon" href="icon.png">
		<script>
			var ctx;
			var fps = 2, last, residue;
			var isdankmode = false;
			var c = { // control
				tom: [1, 0], // tomove
				pos: [[0, 0]],
				gro: 0, // growth queue
				hch: false // has changed dir
			};
			var w = { // world
				dim: 28, // x*x dimension
				csz: 20 // cell size
			}
			window.onload = function() {
				var canv = document.createElement("canvas");
				document.body.appendChild(canv);
				ctx = canv.getContext("2d");
				canv.width = w.csz * w.dim;
				canv.height = w.csz * w.dim;
				window.onkeydown = function(e) {
					console.log(c.pos.length);
					switch (e.key) {
						case "ArrowUp":
						case "w":
							if ((c.tom[1] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [0, -1];
								haschanged = true;
							}
							break;
						case "ArrowLeft":
						case "a":
							if ((c.tom[0] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [-1, 0];
								haschanged = true;
							}
							break;
						case "ArrowDown":
						case "s":
							if ((c.tom[1] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [0, 1];
								haschanged = true;
							}
							break;
						case "ArrowRight":
						case "d":
							if ((c.tom[0] == 0 || c.pos.length == 1) && !haschanged) {
								c.tom = [1, 0];
								haschanged = true;
							}
							break;
					}
				}
				var content = document.createElement("div");
				content.setAttribute("id", "content");
				content.style.position = "absolute";
				content.style.left = "50%";
				content.style.marginLeft = "-" + ((1 + w.csz * w.dim) / 2) + "px";
				content.style.top = w.csz + "px";
				content.style.width = w.csz * w.dim + "px";
				content.style.height = w.csz * w.dim + "px";
				content.style.backgroundColor = "red";
				content.style.border = "1px solid #000";
				document.body.appendChild(content);
				for (var i = 0; i < w.dim * w.dim; i++) {
					var d = document.createElement("div");
					d.setAttribute("id", i);
					d.style.backgroundColor = ((i % 3 == 0) ? ("#afa") : ((i % 3 == 1) ? ("#9e9") : ("#8d8")));
					d.style.position = "absolute";
					d.style.left = (i % w.dim) * w.csz + "px";
					d.style.top = Math.floor(i / w.dim) * w.csz + "px";
					d.style.width = w.csz + "px";
					d.style.height = w.csz + "px";
					content.appendChild(d);
				}
				// debug("raw px margin-left content", window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz));
				
				var snek = document.createElement("div");
				snek.setAttribute("id", "snek");
				snek.style.position = "absolute";
				snek.style.left = "50%";
				snek.style.marginLeft = "-" + ((w.csz * w.dim) / 2) + "px";
				snek.style.top = 1 + w.csz + "px";
				snek.style.width = w.csz * w.dim + "px";
				snek.style.height = w.csz * w.dim + "px";
				// snek.style.backgroundColor = "red";
				document.body.appendChild(snek);
				
				// Initial render
				sd = document.createElement("div");
				sd.style.position = "absolute";
				sd.style.left = (c.pos[c.pos.length - 1][0] * w.csz) + "px";
				sd.style.top = (c.pos[c.pos.length - 1][1] * w.csz) + "px";
				sd.style.width = w.csz + "px";
				sd.style.height = w.csz + "px";
				sd.style.backgroundColor = "#000";
				snek = document.getElementById("snek");
				snek.appendChild(sd);
				
				document.getElementById("darkmodebutton").style.top = (w.csz + 1) + "px";
				document.getElementById("darkmodebutton").style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 81) + "px";
				window.onresize = function() {
					document.getElementById("darkmodebutton").style.left = ((window.innerWidth / 2 - (1 + (w.dim / 2) * w.csz)) - 81) + "px";
				}
				residue = 0;
				last = Date.now();
				window.requestAnimationFrame(main);
			}
			function main() {
				elap = Date.now() - last;
				if (elap + residue >= 1000 / fps) {
					residue = elap + residue - 1000 / fps;
					last = Date.now();					
					// debug("timeError", Date.now() % 1000 + " " + residue);
					
					// Update
					c.pos.push([c.pos[c.pos.length - 1][0] + c.tom[0], c.pos[c.pos.length - 1][1] + c.tom[1]]);
					for (var i = 0; i < c.pos.length - 1; i++) {
						c.pos[i] = [c.pos[i + 1][0], [c.pos[i + 1][1]]];
					}
					c.pos.shift();
					haschanged = false;
					// Render
					sd = document.createElement("div");
					sd.style.position = "absolute";
					sd.style.left = (c.pos[c.pos.length - 1][0] * w.csz) + "px";
					sd.style.top = (c.pos[c.pos.length - 1][1] * w.csz) + "px";
					sd.style.width = w.csz + "px";
					sd.style.height = w.csz + "px";
					sd.style.backgroundColor = "#000";
					snek = document.getElementById("snek");
					snek.appendChild(sd);
					snek.removeChild(snek.querySelector("div"));
				}
				window.requestAnimationFrame(main);
			}
			function debug(head, value) {
				console.log("debug " + head + ": " + value);
			}
			function toggledarkmode() {
				isdankmode = !isdankmode;
				if (isdankmode) {
					document.body.style.backgroundColor = "#000";
					document.getElementById("content").style.border = "1px solid #FFF";
				} else {
					document.body.style.backgroundColor = "#FFF";
					document.getElementById("content").style.border = "1px solid #000";
				}
			}
		</script>
	</head>
	<body>
		<input type="button" id="darkmodebutton" value="Dark Mode" style="position: absolute; padding: 0; width: 74px; height: 30px; text-align: center; border: 1px solid black; opacity: 0.5;" onclick="toggledarkmode()">
	</body>
</html>
